{% extends 'invoices/admin_base.html' %}

{% block title %}取引先会社管理{% endblock %}

{% block page_title %}取引先会社管理{% endblock %}

{% block content %}
<div class="section">
    <h3>取引先会社追加</h3>
    <form id="addCompanyForm">
        {% csrf_token %}
        <div class="grid-2">
            <div class="form-group">
                <label>会社コード *</label>
                <input type="text" name="company_code" id="company_code" value="{{ next_company_code }}" required readonly disabled style="background-color: #f5f5f5; cursor: not-allowed; color: #666;">
                <input type="hidden" name="company_code" value="{{ next_company_code }}">
            </div>
            <div class="form-group">
                <label>会社名 *</label>
                <input type="text" name="company_name" required>
            </div>
            <div class="form-group">
                <label>担当者名 *</label>
                <input type="text" name="contact_person" required>
            </div>
            <div class="form-group">
                <label>郵便番号 *</label>
                <input type="text" name="postal_code" id="postal_code" required placeholder="例: 1000001" maxlength="7">
            </div>
            <div class="form-group">
                <label>都道府県 *</label>
                <select name="prefecture" id="prefecture" required>
                    <option value="">選択してください</option>
                    <option value="北海道">北海道</option>
                    <option value="青森県">青森県</option>
                    <option value="岩手県">岩手県</option>
                    <option value="宮城県">宮城県</option>
                    <option value="秋田県">秋田県</option>
                    <option value="山形県">山形県</option>
                    <option value="福島県">福島県</option>
                    <option value="茨城県">茨城県</option>
                    <option value="栃木県">栃木県</option>
                    <option value="群馬県">群馬県</option>
                    <option value="埼玉県">埼玉県</option>
                    <option value="千葉県">千葉県</option>
                    <option value="東京都">東京都</option>
                    <option value="神奈川県">神奈川県</option>
                    <option value="新潟県">新潟県</option>
                    <option value="富山県">富山県</option>
                    <option value="石川県">石川県</option>
                    <option value="福井県">福井県</option>
                    <option value="山梨県">山梨県</option>
                    <option value="長野県">長野県</option>
                    <option value="岐阜県">岐阜県</option>
                    <option value="静岡県">静岡県</option>
                    <option value="愛知県">愛知県</option>
                    <option value="三重県">三重県</option>
                    <option value="滋賀県">滋賀県</option>
                    <option value="京都府">京都府</option>
                    <option value="大阪府">大阪府</option>
                    <option value="兵庫県">兵庫県</option>
                    <option value="奈良県">奈良県</option>
                    <option value="和歌山県">和歌山県</option>
                    <option value="鳥取県">鳥取県</option>
                    <option value="島根県">島根県</option>
                    <option value="岡山県">岡山県</option>
                    <option value="広島県">広島県</option>
                    <option value="山口県">山口県</option>
                    <option value="徳島県">徳島県</option>
                    <option value="香川県">香川県</option>
                    <option value="愛媛県">愛媛県</option>
                    <option value="高知県">高知県</option>
                    <option value="福岡県">福岡県</option>
                    <option value="佐賀県">佐賀県</option>
                    <option value="長崎県">長崎県</option>
                    <option value="熊本県">熊本県</option>
                    <option value="大分県">大分県</option>
                    <option value="宮崎県">宮崎県</option>
                    <option value="鹿児島県">鹿児島県</option>
                    <option value="沖縄県">沖縄県</option>
                </select>
            </div>
            <div class="form-group">
                <label>市区町村 *</label>
                <input type="text" name="city" id="city" required>
            </div>
            <div class="form-group">
                <label>番地 *</label>
                <input type="text" name="address" id="address" required>
            </div>
            <div class="form-group">
                <label>電話番号 *</label>
                <input type="text" name="phone" id="phone" required placeholder="（ハイフン無）">
            </div>
            <div class="form-group">
                <label>メールアドレス *</label>
                <input type="email" name="email" required placeholder="例: example@domain.com（@必須）">
            </div>
        </div>
        <button type="submit" class="btn btn-primary">追加</button>
    </form>
</div>

<div class="section">
    <h3>取引先会社一覧</h3>
    <table>
        <thead>
            <tr>
                <th>会社コード</th>
                <th>会社名</th>
                <th>担当者</th>
                <th>電話番号</th>
                <th>メールアドレス</th>
                <th>操作</th>
            </tr>
        </thead>
        <tbody>
            {% for company in companies %}
            <tr>
                <td>{{ company.company_code }}</td>
                <td>{{ company.company_name }}</td>
                <td>{{ company.contact_person }}</td>
                <td>{{ company.phone }}</td>
                <td>{{ company.email }}</td>
                <td>
                    <button class="btn btn-danger" onclick="deleteCompany({{ company.id }})" style="padding: 5px 10px; font-size: 12px;">削除</button>
                </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="6" style="text-align: center; color: #999;">取引先会社が登録されていません</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // 全角→半角変換関数
    function toHalfWidth(str) {
        return str.replace(/[Ａ-Ｚａ-ｚ０-９]/g, function(s) {
            return String.fromCharCode(s.charCodeAt(0) - 0xFEE0);
        });
    }

    // 会社コードは自動生成されるため、入力不可（readonly）

    // 郵便番号入力：都道府県・市区町村を自動入力（IME・二重発火対策）
    const postalCodeInput = document.getElementById('postal_code');
    let postalCodeTimeout;
    let isComposing = false;
    let lastPostalCode = '';
    
    postalCodeInput.addEventListener('compositionstart', function() { isComposing = true; });
    postalCodeInput.addEventListener('compositionend', function(e) {
        isComposing = false;
        e.target.dispatchEvent(new Event('input', { bubbles: true }));
    });
    
    postalCodeInput.addEventListener('input', function(e) {
        if (isComposing) return;
        
        let value = e.target.value;
        value = toHalfWidth(value);
        let postalCode = value.replace(/[^0-9]/g, '').slice(0, 7);
        
        // 変化がなければスキップ（二重発火対策）
        if (postalCode === lastPostalCode) return;
        lastPostalCode = postalCode;
        
        if (e.target.value !== postalCode) {
            const cursorPos = e.target.selectionStart;
            const oldLen = e.target.value.length;
            e.target.value = postalCode;
            const lenDiff = postalCode.length - oldLen;
            const newCursorPos = Math.max(0, Math.min(cursorPos + lenDiff, postalCode.length));
            e.target.setSelectionRange(newCursorPos, newCursorPos);
        }
        
        clearTimeout(postalCodeTimeout);
        if (postalCode.length === 7) {
            postalCodeTimeout = setTimeout(() => fetchPostalCode(postalCode), 500);
        }
    });

    async function fetchPostalCode(postalCode) {
        try {
            const response = await fetch(`https://zipcloud.ibsnet.co.jp/api/search?zipcode=${postalCode}`);
            const data = await response.json();
            
            if (data.status === 200 && data.results && data.results.length > 0) {
                const result = data.results[0];
                // 都道府県をセレクトボックスに設定
                const prefectureSelect = document.getElementById('prefecture');
                const prefectureName = result.address1; // 都道府県名
                for (let i = 0; i < prefectureSelect.options.length; i++) {
                    if (prefectureSelect.options[i].value === prefectureName) {
                        prefectureSelect.selectedIndex = i;
                        break;
                    }
                }
                // 市区町村を入力
                document.getElementById('city').value = result.address2 + (result.address3 ? result.address3 : '');
            } else {
                // 郵便番号が見つからない場合
                console.log('郵便番号が見つかりませんでした');
            }
        } catch (error) {
            console.error('郵便番号検索エラー:', error);
        }
    }

    // 市区町村入力欄：全角数字を半角に変換
    const cityInput = document.getElementById('city');
    let isCityProcessing = false;
    
    cityInput.addEventListener('input', function(e) {
        if (isCityProcessing) return; // 処理中の場合はスキップ
        
        const value = e.target.value;
        // 全角数字のみを半角に変換（他の文字はそのまま）
        const converted = value.replace(/[０-９]/g, function(s) {
            return String.fromCharCode(s.charCodeAt(0) - 0xFEE0);
        });
        
        if (value !== converted) {
            isCityProcessing = true;
            const cursorPos = e.target.selectionStart;
            e.target.value = converted;
            
            // カーソル位置を調整
            const newCursorPos = Math.min(cursorPos, converted.length);
            e.target.setSelectionRange(newCursorPos, newCursorPos);
            isCityProcessing = false;
        }
    });

    // 電話番号入力：数字のみ、半角変換、警告
    const phoneInput = document.getElementById('phone');
    let isPhoneProcessing = false;
    
    phoneInput.addEventListener('input', function(e) {
        if (isPhoneProcessing) return; // 処理中の場合はスキップ
        
        let value = e.target.value;
        const originalValue = value;
        // 全角数字を半角に変換
        value = toHalfWidth(value);
        // 数字以外を削除
        const numbersOnly = value.replace(/[^0-9]/g, '');
        
        if (originalValue !== numbersOnly) {
            isPhoneProcessing = true;
            const cursorPos = e.target.selectionStart;
            
            if (value !== numbersOnly) {
                // 数字以外が入力された場合、警告を表示
                alert('電話番号は数字のみ入力してください（ハイフン不要）');
            }
            
            e.target.value = numbersOnly;
            // カーソル位置を調整
            const newCursorPos = Math.min(cursorPos, numbersOnly.length);
            e.target.setSelectionRange(newCursorPos, newCursorPos);
            isPhoneProcessing = false;
        }
    });

    // フォーム送信
    document.getElementById('addCompanyForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        // 市区町村フィールドをaddressに追加（既存のaddressフィールドと結合）
        const city = document.getElementById('city').value;
        const prefecture = document.getElementById('prefecture').value;
        const address = document.getElementById('address').value;
        
        // フォームデータを作成
        const formData = new FormData(this);
        // addressに都道府県と市区町村を追加（既存のaddressは番地として扱う）
        if (city && prefecture && address) {
            formData.set('address', prefecture + city + address);
        } else if (city && prefecture) {
            formData.set('address', prefecture + city);
        }
        
        // 会社コードは自動生成されるため、hidden inputの値を使用（disabled inputは送信されないため）
        const companyCode = document.querySelector('input[name="company_code"][type="hidden"]').value;
        formData.set('company_code', companyCode);
        
        try {
            const response = await fetch('{% url "invoices:add_company" %}', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': formData.get('csrfmiddlewaretoken')
                }
            });
            
            const data = await response.json();
            if (data.success) {
                alert(data.message);
                location.reload();
            } else {
                alert('エラー: ' + data.error);
            }
        } catch (error) {
            alert('エラーが発生しました: ' + error);
        }
    });
    
    // 会社削除
    async function deleteCompany(companyId) {
        if (!confirm('本当に削除しますか？\nこの操作は取り消せません。')) {
            return;
        }
        
        const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        
        try {
            const response = await fetch(`{% url "invoices:delete_company" 0 %}`.replace('0', companyId), {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrftoken
                }
            });
            
            const data = await response.json();
            if (data.success) {
                alert(data.message);
                location.reload();
            } else {
                alert('エラー: ' + data.error);
            }
        } catch (error) {
            alert('エラーが発生しました: ' + error);
        }
    }
</script>
{% endblock %}

