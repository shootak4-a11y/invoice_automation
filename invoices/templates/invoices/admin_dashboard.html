<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>管理画面 - 請求書自動作成システム</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f5f5;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header h1 {
            font-size: 24px;
        }
        
        .nav-links {
            display: flex;
            gap: 15px;
        }
        
        .nav-links a {
            color: white;
            text-decoration: none;
            padding: 8px 15px;
            border-radius: 4px;
            background: rgba(255, 255, 255, 0.2);
            transition: background 0.3s;
        }
        
        .nav-links a:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        .section {
            background: white;
            padding: 25px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .section h2 {
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #555;
            font-weight: 500;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-primary:hover {
            background: #5568d3;
        }
        
        .btn-danger {
            background: #f44336;
            color: white;
        }
        
        .btn-danger:hover {
            background: #da190b;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        
        table th,
        table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        table th {
            background-color: #f8f9fa;
            font-weight: 600;
            color: #333;
        }
        
        .messages {
            margin-bottom: 20px;
        }
        
        .alert {
            padding: 12px 15px;
            border-radius: 4px;
            margin-bottom: 10px;
        }
        
        .alert-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .alert-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        @media (max-width: 768px) {
            .grid-2 {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>管理画面</h1>
            <div class="nav-links">
                <a href="{% url 'invoices:create_invoice_view' %}">請求書作成</a>
                <a href="{% url 'invoices:logout' %}">ログアウト</a>
            </div>
        </div>
        
        {% if messages %}
        <div class="messages">
            {% for message in messages %}
            <div class="alert alert-{{ message.tags }}">
                {{ message }}
            </div>
            {% endfor %}
        </div>
        {% endif %}
        
        <div class="grid-2">
            <!-- 取引先会社追加 -->
            <div class="section">
                <h2>取引先会社追加</h2>
                <form id="addCompanyForm">
                    {% csrf_token %}
                    <div class="form-group">
                        <label>会社コード *</label>
                        <input type="text" name="company_code" id="dashboard_company_code" value="{{ next_company_code }}" required readonly disabled style="background-color: #f5f5f5; cursor: not-allowed; color: #666;">
                        <input type="hidden" name="company_code" value="{{ next_company_code }}">
                    </div>
                    <div class="form-group">
                        <label>会社名 *</label>
                        <input type="text" name="company_name" required>
                    </div>
                    <div class="form-group">
                        <label>担当者名 *</label>
                        <input type="text" name="contact_person" required>
                    </div>
                    <div class="form-group">
                        <label>郵便番号 *</label>
                        <input type="text" name="postal_code" id="dashboard_postal_code" required placeholder="例: 1000001" maxlength="7">
                    </div>
                    <div class="form-group">
                        <label>都道府県 *</label>
                        <select name="prefecture" id="dashboard_prefecture" required>
                            <option value="">選択してください</option>
                            <option value="北海道">北海道</option>
                            <option value="青森県">青森県</option>
                            <option value="岩手県">岩手県</option>
                            <option value="宮城県">宮城県</option>
                            <option value="秋田県">秋田県</option>
                            <option value="山形県">山形県</option>
                            <option value="福島県">福島県</option>
                            <option value="茨城県">茨城県</option>
                            <option value="栃木県">栃木県</option>
                            <option value="群馬県">群馬県</option>
                            <option value="埼玉県">埼玉県</option>
                            <option value="千葉県">千葉県</option>
                            <option value="東京都">東京都</option>
                            <option value="神奈川県">神奈川県</option>
                            <option value="新潟県">新潟県</option>
                            <option value="富山県">富山県</option>
                            <option value="石川県">石川県</option>
                            <option value="福井県">福井県</option>
                            <option value="山梨県">山梨県</option>
                            <option value="長野県">長野県</option>
                            <option value="岐阜県">岐阜県</option>
                            <option value="静岡県">静岡県</option>
                            <option value="愛知県">愛知県</option>
                            <option value="三重県">三重県</option>
                            <option value="滋賀県">滋賀県</option>
                            <option value="京都府">京都府</option>
                            <option value="大阪府">大阪府</option>
                            <option value="兵庫県">兵庫県</option>
                            <option value="奈良県">奈良県</option>
                            <option value="和歌山県">和歌山県</option>
                            <option value="鳥取県">鳥取県</option>
                            <option value="島根県">島根県</option>
                            <option value="岡山県">岡山県</option>
                            <option value="広島県">広島県</option>
                            <option value="山口県">山口県</option>
                            <option value="徳島県">徳島県</option>
                            <option value="香川県">香川県</option>
                            <option value="愛媛県">愛媛県</option>
                            <option value="高知県">高知県</option>
                            <option value="福岡県">福岡県</option>
                            <option value="佐賀県">佐賀県</option>
                            <option value="長崎県">長崎県</option>
                            <option value="熊本県">熊本県</option>
                            <option value="大分県">大分県</option>
                            <option value="宮崎県">宮崎県</option>
                            <option value="鹿児島県">鹿児島県</option>
                            <option value="沖縄県">沖縄県</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>市区町村 *</label>
                        <input type="text" name="city" id="dashboard_city" required>
                    </div>
                    <div class="form-group">
                        <label>番地 *</label>
                        <input type="text" name="address" id="dashboard_address" required>
                    </div>
                    <div class="form-group">
                        <label>電話番号 *</label>
                        <input type="text" name="phone" id="dashboard_phone" required placeholder="（ハイフン無）">
                    </div>
                    <div class="form-group">
                        <label>メールアドレス *</label>
                        <input type="email" name="email" required placeholder="例: example@domain.com（@必須）">
                    </div>
                    <button type="submit" class="btn btn-primary">追加</button>
                </form>
            </div>
            
            <!-- 請求書項目追加 -->
            <div class="section">
                <h2>請求書項目追加</h2>
                <form id="addInvoiceItemForm">
                    {% csrf_token %}
                    <div class="form-group">
                        <label>項目名 *</label>
                        <input type="text" name="name" required>
                    </div>
                    <div class="form-group">
                        <label>説明</label>
                        <textarea name="description" rows="3"></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary">追加</button>
                </form>
            </div>
        </div>
        
        <!-- ユーザー管理（管理者以上） -->
        {% if is_admin %}
        <div class="section">
            <h2>ユーザー管理</h2>
            <form id="addUserForm" style="margin-bottom: 20px;">
                {% csrf_token %}
                <div class="grid-2">
                    <div class="form-group">
                        <label>ユーザー名 *</label>
                        <input type="text" name="username" required>
                    </div>
                    <div class="form-group">
                        <label>パスワード *</label>
                        <input type="password" name="password" required>
                    </div>
                    <div class="form-group">
                        <label>ユーザー種別 *</label>
                        <select name="role" required>
                            <option value="general">一般</option>
                            <option value="manager">管理者</option>
                            <option value="director">責任者</option>
                        </select>
                    </div>
                    <div class="form-group" style="display: flex; align-items: flex-end;">
                        <button type="submit" class="btn btn-primary">ユーザー追加</button>
                    </div>
                </div>
            </form>
            
            <table>
                <thead>
                    <tr>
                        <th>ユーザー名</th>
                        <th>ユーザー種別</th>
                        <th>作成日時</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody>
                    {% for user in users %}
                    <tr>
                        <td>{{ user.username }}</td>
                        <td>{{ user.get_role_display }}</td>
                        <td>{{ user.created_at|date:"Y-m-d H:i" }}</td>
                        <td>
                            {% if user != request.user %}
                            <button class="btn btn-danger" onclick="deleteUser({{ user.id }})">削除</button>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% endif %}
        
        <!-- 取引先会社一覧 -->
        <div class="section">
            <h2>取引先会社一覧</h2>
            <table>
                <thead>
                    <tr>
                        <th>会社コード</th>
                        <th>会社名</th>
                        <th>担当者</th>
                        <th>電話番号</th>
                        <th>メールアドレス</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody>
                    {% for company in companies %}
                    <tr>
                        <td>{{ company.company_code }}</td>
                        <td>{{ company.company_name }}</td>
                        <td>{{ company.contact_person }}</td>
                        <td>{{ company.phone }}</td>
                        <td>{{ company.email }}</td>
                        <td>
                            <button class="btn btn-danger" onclick="deleteCompany({{ company.id }})" style="padding: 5px 10px; font-size: 12px;">削除</button>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="6" style="text-align: center; color: #999;">取引先会社が登録されていません</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <!-- 請求書作成 -->
        <div class="section">
            <h2>請求書作成</h2>
            <form id="invoiceForm" method="post" action="{% url 'invoices:generate_invoice' %}">
                {% csrf_token %}
                
                <!-- 会社コード入力 -->
                <div class="form-group">
                    <label for="admin_company_code">会社コード *</label>
                    <input 
                        type="text" 
                        id="admin_company_code" 
                        name="company_code" 
                        required 
                        placeholder="会社コードを入力してください"
                        style="text-transform: uppercase;"
                        autocomplete="off"
                    >
                    <div class="loading" id="admin_loading" style="display: none; color: #667eea; margin-top: 5px;">読み込み中...</div>
                </div>
                
                <div id="admin_companyInfo" class="company-info" style="display: none; background: #f8f9fa; padding: 15px; border-radius: 4px; margin-top: 15px;">
                    <div class="company-info-item" style="margin-bottom: 8px; display: flex;">
                        <label style="width: 120px; font-weight: 600; color: #666;">会社名:</label>
                        <span id="admin_company_name" style="color: #333;"></span>
                    </div>
                    <div class="company-info-item" style="margin-bottom: 8px; display: flex;">
                        <label style="width: 120px; font-weight: 600; color: #666;">担当者:</label>
                        <span id="admin_contact_person" style="color: #333;"></span>
                    </div>
                    <div class="company-info-item" style="margin-bottom: 8px; display: flex;">
                        <label style="width: 120px; font-weight: 600; color: #666;">番地:</label>
                        <span id="admin_address" style="color: #333;"></span>
                    </div>
                    <div class="company-info-item" style="margin-bottom: 8px; display: flex;">
                        <label style="width: 120px; font-weight: 600; color: #666;">郵便番号/都道府県:</label>
                        <span id="admin_postal_prefecture" style="color: #333;"></span>
                    </div>
                    <div class="company-info-item" style="margin-bottom: 8px; display: flex;">
                        <label style="width: 120px; font-weight: 600; color: #666;">電話番号:</label>
                        <span id="admin_phone" style="color: #333;"></span>
                    </div>
                    <div class="company-info-item" style="margin-bottom: 8px; display: flex;">
                        <label style="width: 120px; font-weight: 600; color: #666;">メールアドレス:</label>
                        <span id="admin_email" style="color: #333;"></span>
                    </div>
                </div>
                
                <!-- 請求書情報 -->
                <div class="form-group" style="margin-top: 20px;">
                    <label for="admin_invoice_number">請求書番号 *</label>
                    <input type="text" id="admin_invoice_number" name="invoice_number" required>
                </div>
                
                <!-- 請求内訳 -->
                <div style="margin-top: 20px;">
                    <label style="display: block; margin-bottom: 10px; color: #555; font-weight: 500;">請求内訳</label>
                    <div style="max-height: 400px; overflow-y: auto; border: 1px solid #ddd; border-radius: 4px; padding: 15px;">
                        <div style="display: grid; grid-template-columns: 2fr 1fr 1fr 1fr; gap: 10px; margin-bottom: 10px; padding: 10px; background: #667eea; color: white; border-radius: 4px; font-weight: 600;">
                            <div>請求内容</div>
                            <div>個数</div>
                            <div>単価</div>
                            <div>金額</div>
                        </div>
                        {% for i in "0123456789" %}
                        <div class="admin-item-row" style="display: grid; grid-template-columns: 2fr 1fr 1fr 1fr; gap: 10px; margin-bottom: 10px; padding: 10px; background: #f8f9fa; border-radius: 4px;">
                            <input type="text" name="item_name[]" placeholder="請求内容" class="admin-item-name" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            <input type="number" name="item_quantity[]" placeholder="個数" min="1" value="1" class="admin-item-quantity" onchange="calculateAdminAmount(this)" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            <input type="number" name="item_price[]" placeholder="単価" min="0" step="0.01" value="0" class="admin-item-price" onchange="calculateAdminAmount(this)" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            <input type="number" name="item_amount[]" placeholder="金額" min="0" step="0.01" value="0" class="admin-item-amount" readonly style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                        {% endfor %}
                    </div>
                </div>
                
                <!-- ボタン -->
                <div style="margin-top: 20px;">
                    <button type="submit" class="btn btn-primary">請求書作成</button>
                    <button type="button" class="btn btn-secondary" onclick="clearAdminForm()">クリア</button>
                </div>
            </form>
        </div>
        
        <!-- 月ごとの取引履歴出力 -->
        <div class="section">
            <h2>月ごとの取引履歴出力</h2>
            <form method="post" action="{% url 'invoices:export_monthly_history' %}">
                {% csrf_token %}
                <div class="grid-2">
                    <div class="form-group">
                        <label for="history_company_code">会社コード *</label>
                        <input 
                            type="text" 
                            id="history_company_code" 
                            name="company_code" 
                            required 
                            placeholder="会社コードを入力"
                            style="text-transform: uppercase;"
                        >
                    </div>
                    <div class="form-group">
                        <label for="year">年 *</label>
                        <input type="number" id="year" name="year" required min="2000" max="2100">
                    </div>
                    <div class="form-group">
                        <label for="month">月 *</label>
                        <select id="month" name="month" required>
                            <option value="1">1月</option>
                            <option value="2">2月</option>
                            <option value="3">3月</option>
                            <option value="4">4月</option>
                            <option value="5">5月</option>
                            <option value="6">6月</option>
                            <option value="7">7月</option>
                            <option value="8">8月</option>
                            <option value="9">9月</option>
                            <option value="10">10月</option>
                            <option value="11">11月</option>
                            <option value="12">12月</option>
                        </select>
                    </div>
                    <div class="form-group" style="display: flex; align-items: flex-end;">
                        <button type="submit" class="btn btn-success">取引履歴を出力</button>
                    </div>
                </div>
            </form>
        </div>
    </div>
    
    <script>
        // 全角→半角変換関数
        function toHalfWidth(str) {
            return str.replace(/[Ａ-Ｚａ-ｚ０-９]/g, function(s) {
                return String.fromCharCode(s.charCodeAt(0) - 0xFEE0);
            });
        }

        // 会社コードは自動生成されるため、入力不可（readonly）

        // 郵便番号入力：都道府県・市区町村を自動入力（重複入力を防ぐ）
        const dashboardPostalCodeInput = document.getElementById('dashboard_postal_code');
        let dashboardPostalCodeTimeout;
        let dashboardPostalCodeHandler = null;
        
        dashboardPostalCodeHandler = function(e) {
            let value = e.target.value;
            // 全角数字を半角に変換
            value = toHalfWidth(value);
            // 数字以外を削除
            let postalCode = value.replace(/[^0-9]/g, '');
            
            if (e.target.value !== postalCode) {
                // イベントリスナーを一時的に削除
                dashboardPostalCodeInput.removeEventListener('input', dashboardPostalCodeHandler);
                
                const cursorPos = e.target.selectionStart;
                e.target.value = postalCode;
                // カーソル位置を調整
                const newCursorPos = Math.min(cursorPos, postalCode.length);
                e.target.setSelectionRange(newCursorPos, newCursorPos);
                
                // イベントリスナーを再度追加（次のフレームで）
                setTimeout(() => {
                    dashboardPostalCodeInput.addEventListener('input', dashboardPostalCodeHandler);
                }, 0);
            }
            
            clearTimeout(dashboardPostalCodeTimeout);
            
            if (postalCode.length === 7) {
                dashboardPostalCodeTimeout = setTimeout(() => {
                    fetchDashboardPostalCode(postalCode);
                }, 500);
            } else if (postalCode.length < 7) {
                // 郵便番号が不完全な場合はクリア
                document.getElementById('dashboard_prefecture').value = '';
                document.getElementById('dashboard_city').value = '';
            }
        };
        
        dashboardPostalCodeInput.addEventListener('input', dashboardPostalCodeHandler);

        async function fetchDashboardPostalCode(postalCode) {
            try {
                const response = await fetch(`https://zipcloud.ibsnet.co.jp/api/search?zipcode=${postalCode}`);
                const data = await response.json();
                
                if (data.status === 200 && data.results && data.results.length > 0) {
                    const result = data.results[0];
                    // 都道府県をセレクトボックスに設定
                    const prefectureSelect = document.getElementById('dashboard_prefecture');
                    const prefectureName = result.address1; // 都道府県名
                    for (let i = 0; i < prefectureSelect.options.length; i++) {
                        if (prefectureSelect.options[i].value === prefectureName) {
                            prefectureSelect.selectedIndex = i;
                            break;
                        }
                    }
                    // 市区町村を入力
                    document.getElementById('dashboard_city').value = result.address2 + (result.address3 ? result.address3 : '');
                } else {
                    // 郵便番号が見つからない場合
                    console.log('郵便番号が見つかりませんでした');
                }
            } catch (error) {
                console.error('郵便番号検索エラー:', error);
            }
        }

        // 市区町村入力欄：全角数字を半角に変換（重複入力を防ぐ）
        const dashboardCityInput = document.getElementById('dashboard_city');
        let dashboardCityHandler = null;
        
        dashboardCityHandler = function(e) {
            const value = e.target.value;
            // 全角数字のみを半角に変換（他の文字はそのまま）
            const converted = value.replace(/[０-９]/g, function(s) {
                return String.fromCharCode(s.charCodeAt(0) - 0xFEE0);
            });
            
            if (value !== converted) {
                // イベントリスナーを一時的に削除
                dashboardCityInput.removeEventListener('input', dashboardCityHandler);
                
                const cursorPos = e.target.selectionStart;
                e.target.value = converted;
                
                // カーソル位置を調整
                const newCursorPos = Math.min(cursorPos, converted.length);
                e.target.setSelectionRange(newCursorPos, newCursorPos);
                
                // イベントリスナーを再度追加（次のフレームで）
                setTimeout(() => {
                    dashboardCityInput.addEventListener('input', dashboardCityHandler);
                }, 0);
            }
        };
        
        dashboardCityInput.addEventListener('input', dashboardCityHandler);

        // 電話番号入力：数字のみ、半角変換、警告（重複入力を防ぐ）
        const dashboardPhoneInput = document.getElementById('dashboard_phone');
        let dashboardPhoneHandler = null;
        
        dashboardPhoneHandler = function(e) {
            let value = e.target.value;
            const originalValue = value;
            // 全角数字を半角に変換
            value = toHalfWidth(value);
            // 数字以外を削除
            const numbersOnly = value.replace(/[^0-9]/g, '');
            
            if (originalValue !== numbersOnly) {
                // イベントリスナーを一時的に削除
                dashboardPhoneInput.removeEventListener('input', dashboardPhoneHandler);
                
                const cursorPos = e.target.selectionStart;
                
                if (value !== numbersOnly) {
                    // 数字以外が入力された場合、警告を表示
                    alert('電話番号は数字のみ入力してください（ハイフン不要）');
                }
                
                e.target.value = numbersOnly;
                // カーソル位置を調整
                const newCursorPos = Math.min(cursorPos, numbersOnly.length);
                e.target.setSelectionRange(newCursorPos, newCursorPos);
                
                // イベントリスナーを再度追加（次のフレームで）
                setTimeout(() => {
                    dashboardPhoneInput.addEventListener('input', dashboardPhoneHandler);
                }, 0);
            }
        };
        
        dashboardPhoneInput.addEventListener('input', dashboardPhoneHandler);

        // 取引先会社追加
        document.getElementById('addCompanyForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // 市区町村フィールドをaddressに追加（既存のaddressフィールドと結合）
            const city = document.getElementById('dashboard_city').value;
            const prefecture = document.getElementById('dashboard_prefecture').value;
            const address = document.getElementById('dashboard_address').value;
            
            // フォームデータを作成
            const formData = new FormData(this);
            // addressに都道府県と市区町村を追加（既存のaddressは番地として扱う）
            if (city && prefecture && address) {
                formData.set('address', prefecture + city + address);
            } else if (city && prefecture) {
                formData.set('address', prefecture + city);
            }
            
            // 会社コードは自動生成されるため、hidden inputの値を使用（disabled inputは送信されないため）
            const companyCode = document.querySelector('input[name="company_code"][type="hidden"]').value;
            formData.set('company_code', companyCode);
            
            try {
                const response = await fetch('{% url "invoices:add_company" %}', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-CSRFToken': formData.get('csrfmiddlewaretoken')
                    }
                });
                
                const data = await response.json();
                if (data.success) {
                    alert(data.message);
                    location.reload();
                } else {
                    alert('エラー: ' + data.error);
                }
            } catch (error) {
                alert('エラーが発生しました: ' + error);
            }
        });
        
        // 請求書項目追加
        document.getElementById('addInvoiceItemForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            
            try {
                const response = await fetch('{% url "invoices:add_invoice_item_template" %}', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-CSRFToken': formData.get('csrfmiddlewaretoken')
                    }
                });
                
                const data = await response.json();
                if (data.success) {
                    alert(data.message);
                    this.reset();
                } else {
                    alert('エラー: ' + data.error);
                }
            } catch (error) {
                alert('エラーが発生しました: ' + error);
            }
        });
        
        // ユーザー追加
        {% if is_admin %}
        document.getElementById('addUserForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            
            try {
                const response = await fetch('{% url "invoices:add_user" %}', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-CSRFToken': formData.get('csrfmiddlewaretoken')
                    }
                });
                
                const data = await response.json();
                if (data.success) {
                    alert(data.message);
                    location.reload();
                } else {
                    alert('エラー: ' + data.error);
                }
            } catch (error) {
                alert('エラーが発生しました: ' + error);
            }
        });
        
        // ユーザー削除
        async function deleteUser(userId) {
            if (!confirm('このユーザーを削除しますか？')) {
                return;
            }
            
            const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            
            try {
                const response = await fetch(`{% url "invoices:delete_user" 0 %}`.replace('0', userId), {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': csrftoken
                    }
                });
                
                const data = await response.json();
                if (data.success) {
                    alert(data.message);
                    location.reload();
                } else {
                    alert('エラー: ' + data.error);
                }
            } catch (error) {
                alert('エラーが発生しました: ' + error);
            }
        }
        {% endif %}
        
        // 管理画面の請求書作成機能
        // 会社コード入力時の自動入力
        let adminCompanyCodeTimeout;
        document.getElementById('admin_company_code').addEventListener('input', function() {
            const companyCode = this.value.toUpperCase();
            clearTimeout(adminCompanyCodeTimeout);
            
            if (companyCode.length >= 2) {
                adminCompanyCodeTimeout = setTimeout(() => {
                    loadAdminCompanyInfo(companyCode);
                }, 500);
            } else {
                document.getElementById('admin_companyInfo').style.display = 'none';
            }
        });
        
        async function loadAdminCompanyInfo(companyCode) {
            const loadingEl = document.getElementById('admin_loading');
            const companyInfoEl = document.getElementById('admin_companyInfo');
            
            loadingEl.style.display = 'block';
            companyInfoEl.style.display = 'none';
            
            try {
                const response = await fetch(`{% url 'invoices:get_company_info' %}?company_code=${companyCode}`);
                const data = await response.json();
                
                if (data.success) {
                    const company = data.company;
                    document.getElementById('admin_company_name').textContent = company.company_name;
                    document.getElementById('admin_contact_person').textContent = company.contact_person;
                    document.getElementById('admin_address').textContent = company.address;
                    document.getElementById('admin_postal_prefecture').textContent = `${company.postal_code} ${company.prefecture}`;
                    document.getElementById('admin_phone').textContent = company.phone;
                    document.getElementById('admin_email').textContent = company.email;
                    companyInfoEl.style.display = 'block';
                } else {
                    companyInfoEl.style.display = 'none';
                    if (companyCode.length >= 3) {
                        alert('会社コードが見つかりません: ' + data.error);
                    }
                }
            } catch (error) {
                console.error('Error:', error);
                companyInfoEl.style.display = 'none';
            } finally {
                loadingEl.style.display = 'none';
            }
        }
        
        // 金額計算（管理画面用）
        function calculateAdminAmount(input) {
            const row = input.closest('.admin-item-row');
            const quantity = parseFloat(row.querySelector('.admin-item-quantity').value) || 0;
            const price = parseFloat(row.querySelector('.admin-item-price').value) || 0;
            const amount = quantity * price;
            row.querySelector('.admin-item-amount').value = amount.toFixed(2);
        }
        
        // フォームクリア（管理画面用）
        function clearAdminForm() {
            if (confirm('入力内容をクリアしますか？')) {
                document.getElementById('invoiceForm').reset();
                document.getElementById('admin_companyInfo').style.display = 'none';
                // 金額を再計算
                document.querySelectorAll('.admin-item-row').forEach(row => {
                    calculateAdminAmount(row.querySelector('.admin-item-quantity'));
                });
            }
        }
        
        // 現在の年月を設定
        const now = new Date();
        document.getElementById('year').value = now.getFullYear();
        document.getElementById('month').value = now.getMonth() + 1;
        
        // 会社削除
        async function deleteCompany(companyId) {
            if (!confirm('本当に削除しますか？\nこの操作は取り消せません。')) {
                return;
            }
            
            const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            
            try {
                const response = await fetch(`{% url "invoices:delete_company" 0 %}`.replace('0', companyId), {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': csrftoken
                    }
                });
                
                const data = await response.json();
                if (data.success) {
                    alert(data.message);
                    location.reload();
                } else {
                    alert('エラー: ' + data.error);
                }
            } catch (error) {
                alert('エラーが発生しました: ' + error);
            }
        }
    </script>
</body>
</html>

